# Setting up Vault on Openshift

This Documentation should describe how to setup an instance of Vault on Openshift using best gitops practices. It is modeled off the Rosa deployment, so their might be minor changes that need to be made to work for other environments. However this document should still serve as a guide in how other teams might attempt something similar.

## Step 1: Migrate Gitops manifests
Move over all the vault manifests into the Gitops repo. My PR for reference is here: https://github.com/redhat-et/rosa-apps/pull/28/files. There are 4 types of files / paths one should be aware of to migrate the gitops manifests:
  1. `cluster-scope/base` -- these refer to any base level cluster scoped resources related to installing vault. 
    - these include: [the Vault `namespace`](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-dc867cc78ea14fc6e735fb0cf1dcfc361ad17b504400fd36a0447e4631da0998), [the `vault-secret-fetcher` serviceaccount](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-b35ba58eeb588caebfd77b89070f9ab9117ec2c37d288132fa1ef5cf8eb2583e), [the Vault `clusterrolebinding`](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-c9da9d77a1782eada8333c22410032d36b780839a29bcb4aaf8daa463f1c336f), and [the Vault bundle](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-9261b1f91c0d5ce9f43fe188d0752965872c7a73d7910ed7c1276cb230225d0e). The bundle simply groups together the `clusterrolebinding` and `namespace`. This is not required, but if you skip this make sure to add both of those resources to the deployment overlay (`cluster-scope/overlay/<cluster_name>/kustomization.yaml`) instead of adding the bundle.
  2. `cluster-scope/overlay` -- these are resources that are cluster scoped but instance / implementation specific. Examples include the [overlay kustomization](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-f4f95bdea566edd5d1aaa9c7818dd317ff017b4e592dcf06007fc441f0182ab0), which is what actually deploys all these cluster-scoped resources to the cluster as the `cluster-resources` argocd app. What you need to add here are the cluster-scoped resources that we added that are specifc to vault (see above manifest subcatagory 1).
  3.  ` argocd` -- these are the argocd manifests that will deploy vault. In the applications on the rosa overlay for argocd, add [an application for Vault](https://github.com/redhat-et/rosa-apps/pull/28/files#diff-4440958ecb916b2937be43eee3f3ede2dc516a023c845456e57b3b433147b5a8) and reference it in the `kustomization.yaml` so it can get picked up by the `app-of-apps`.
  4. `vault` -- the vault application overlay. This contains the base and overlay manifests that are specific to the vault application. In base make sure to rename all the manifests and instances to suite your environment. For instance I changed it from `opf` to `rosa`. Not certain if the labels can be dropped I did not try it. Overlays contains everything related to the backupjobs, these can be commented out of the kustomization if you dont want to run the backups. If not make sure to adjust those as well.

## Step 2: Verify Argocd Syncs the Vault Application
Verify that your Argocd project has the correct permssions to sync, this was an issue for the Rosa cluster. We deploy our argocd-project permssions as an Argocd `application` so that we can track them in git.

- Potential pitfall: in Argocd `NAMESPACE RESOURCE ALLOW LIST` are case sensitive. If it won't let you sync certain manifests for this reason, and gives you the error message: `lack permisions to sync <kind>:<group> in project <argocd_project_name>`, then whitelist the various resources and check casing. After this, vault will deploy, navigate to that namespace and click on the working vault route.

## Step 3: Initializing Vault
When a new vault instance is initalized it will tell you Vault is sealed by default, and will ask you if you want to `join an existing raft cluster` or `Create a new raft cluster`, [see here](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fvault%2Fvault-gs-ui-1.png). Select `Create a new raft cluster`. After this it will take you to [the next screen](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fvault%2Fvault-gs-ui-initialize.png) where you are to setup your initial set of master keys in case of emergency. [According to Vault documentation](https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-deploy#initializing-the-vault), selecting 5 `key shares` and seting the `key threashold` to 3 is acceptable for a standard installation. This means that in the case vault is locked up for some reason, there are a total of 5 master keys and you need at least 3 of them to unlock Vault. Make sure to backup or save the `key share`s and `initial-root-token` that it provides you. After that login with the token option, and use the `inital-root-token` as that token value.

## Step 4: Setup User-Password Authentication (Optional)
This step is optional based on how you want to do authentication to Vault. However, even if it is not your prefered method of authentication, it is suggested that you set it up becuase OIDC authentication while safer and easier is significantly more difficult to setup. Authentication via `userpass` serves as a good backup 

Starting with the lowest hanging fruit of all authentication types, user password. Select `Access` in the top left of your vault instance and navigate to `Auth Methods` if not already there. Click `Enable new Auth Method` in the Top right, and select `Username & Password` in the top right. You don't need to fill anything out here, you dont even need to click on the `Method Options` dropdown. Click the blue button and proceed. You can now create users here and provide them with crednetials. This is the easiest but least secure method to do authentication. NOTE: Usernames are not case sensitive. You can create or provide pre-created policies, and reference the policy in the user's `Generated Token's Policies` field to apply policies to a user.

## Step 5: Create A Secrets Engine
Vault has this concept of a secrets engines, which according to their documentation, are "Vault components which store, generate or encrypt secrets". They may vary in their methods and responsibilites of secret creation, such as reading and writing of basic key value secrets, connecting to other services which create dynamic secrets, or providing encryption as a service. We will be sticking with the basic key value `v2` secrets engine. Click on the `Secrets` tab in the top left corner, and then click `Enable new engine` in the top right corner. Make sure to select the the `KV` in the  `Generic` engine type row. Set your secret path, for us we use `k8s_secrets`, but this may be whatever you wish. Do not change any other settings, and you have succesfully created your secrets engine.

Congratulations, you have properly deployed a Vault instance using Gitops on Openshift, intialized and unsealed a Vault cluster, potentially created a userpass authentication method, and created a secrets engine. To setup Vault to work via authenticating to your openshift cluster, and deriving vault permisions based on Openshift groups continue on to the [`Setting-Up-Vault-OIDC.md`](./Setting-Up-Vault-OIDC.md).
